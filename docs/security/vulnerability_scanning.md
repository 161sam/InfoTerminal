# Vulnerability Scanning

InfoTerminal enforces two vulnerability gates:

- **Dependency SCA (`vuln_policy_sca`)** for Python and Node.js dependencies.
- **Container image scanning (`vuln_policy_images`)** for every referenced runtime image.

Both gates write deterministic artefacts to `artifacts/security/` and expose a
Markdown summary used for sticky pull-request comments.

## Dependency vulnerability scanning (`vuln_policy_sca`)

### Overview

| Target | Scanner | Source Files | Output |
| --- | --- | --- | --- |
| Python services | OSV `querybatch` + per-vulnerability lookups | `requirements*.txt` (services, tests, etl) | `artifacts/security/sca/python/*.json` |
| Node workspace | `pnpm audit --json` | `pnpm-lock.yaml` | `artifacts/security/sca/node/pnpm-audit.json` |

The gate is implemented in `scripts/run_vuln_policy_sca.py`. It normalises
severity levels, aggregates results across ecosystems, and enforces the
`vuln_policy_sca` thresholds defined in `policy/vuln_policy_sca.json`.

### Running the scan locally

```bash
python scripts/run_vuln_policy_sca.py
```

The command performs the following steps:

1. Collects all `requirements*.txt` manifests and queries [osv.dev](https://osv.dev)
   for every pinned package. Unpinned requirements are reported as skipped and do
   not contribute to the vulnerability totals.
2. Executes `pnpm audit --json` against the workspace lockfile to detect Node
   vulnerabilities.
3. Writes deterministic artefacts under `artifacts/security/sca/`:
   - Per-manifest reports (`python/*.json`) mirroring OSV responses.
   - The raw `pnpm-audit.json` output (`node/`).
   - `sca_summary.json` and `sca_summary.html` with aggregated counts, policy
     status, and the top five advisories.
   - `pr_comment.md`, a ready-to-post Markdown summary used by CI for automated
     pull-request updates.

If high/critical issues are present, the script exits with status `1`. To inspect
results without failing your shell session, append `|| true`.

### Policy configuration

`policy/vuln_policy_sca.json` stores the default severity thresholds:

```json
{
  "fail_threshold": "high",
  "warn_threshold": "medium"
}
```

The CLI accepts overrides via environment variables:

- `VULN_POLICY_SCA_FAIL_LEVEL` – override the fail threshold (e.g. `critical`).
- `VULN_POLICY_SCA_WARN_LEVEL` – override the warn threshold.

Both values must be one of `critical`, `high`, `medium`, `low`, `info`, or
`unknown`.

Skipped (unpinned) Python requirements are counted and surfaced in the summary
and PR comment. Use these lists to pin versions or add lockfiles so the scanner
can evaluate them.

### CI integration

The GitHub Actions job `vuln-policy-sca` (see `.github/workflows/ci.yml`) runs on
every push and pull request:

1. Installs pnpm dependencies with `pnpm install --frozen-lockfile --ignore-scripts`.
2. Runs `python scripts/run_vuln_policy_sca.py`, captures the exit code, and
   commits no changes.
3. Posts the contents of `artifacts/security/sca/pr_comment.md` as a sticky PR
   comment when applicable.
4. Fails the job if the recorded exit code is non-zero (i.e. high/critical
   vulnerabilities were detected).

Because the repository currently includes several high-severity issues (see the
summary artefacts), the gate fails until the affected dependencies are upgraded.
Adjust the policy only for exceptional cases; long-term remediation should update
the pinned versions so the scan returns green.

## Container image scanning (`vuln_policy_images`)

### Overview

| Target | Scanner | Source Files | Output |
| --- | --- | --- | --- |
| Container images referenced in Compose + production manifests | `trivy image --format json` | `docker-compose*.yml`, `deploy/kubernetes/production.yaml` | `artifacts/security/images/reports/*.trivy.json` |

Image discovery reuses the logic from `scripts/generate_image_sboms.py`, ensuring
the SBOM and vulnerability inventories stay aligned.

### Running the scan locally

```bash
python scripts/run_vuln_policy_images.py
```

Useful options and environment variables:

- `--dry-run` or `DRY_RUN=1` prints the image list and the Trivy commands without
  executing them.
- `--images <ref...>` restricts the scan to a subset for faster iteration.
- `--fail-threshold` / `--warn-threshold` override policy levels for the current run.
- `TRIVY_CMD=<custom>` points to an alternative Trivy binary or wrapper (e.g. a
  Docker wrapper). By default the script looks for `trivy` on `$PATH`.
- `TRIVY_SKIP_UPDATE=1` disables DB updates for offline runs (the cache must
  already exist).
- `VULN_POLICY_IMAGES_FAIL_LEVEL` and `VULN_POLICY_IMAGES_WARN_LEVEL` mirror the
  dependency gate overrides.

On every run the script:

1. Discovers all referenced images, including duplicates across Compose profiles.
2. Executes `trivy image --format json` for each reference and stores the output
   under `artifacts/security/images/reports/`.
3. Generates `scan_summary.json`, `scan_summary.html`, and `pr_comment.md`
   aggregating counts, policy status, and deltas to the previously committed
   summary.
4. Enforces the policy thresholds: the command exits with `1` if any
   High/Critical vulnerability remains unapproved; Medium issues trigger a
   warning but do not fail the exit code.

### Baseline governance

Accepted findings live in `policy/vuln_baseline_images.json`:

```json
{
  "metadata": {
    "description": "Accepted container vulnerabilities with justification and expiry.",
    "last_reviewed": "2025-09-26",
    "owner": "security"
  },
  "acceptances": [
    {
      "id": "CVE-2024-9999",
      "images": ["infoterminal/frontend:latest"],
      "components": ["openssl"],
      "reason": "Upstream fix scheduled for October maintenance window.",
      "expires": "2025-12-31T00:00:00+00:00",
      "owner": "platform",
      "notes": "Monitor upstream issue 1234 for patch availability."
    }
  ]
}
```

Baseline rules:

1. Every entry requires `id`, `reason`, and `expires`. Missing fields cause the
   gate to abort.
2. Expired entries are flagged as policy violations and listed in the summary.
3. `images` may be a list or the wildcard `"*"` to apply broadly. `components`
   filters by the affected package (Trivy `PkgName`).
4. Keep `metadata.last_reviewed` in sync with the most recent approval cycle and
   review the file at least quarterly.

The summary highlights expiring and expired approvals, and the PR comment lists
both accepted and active findings so reviewers can verify the baseline.

### Artefacts and PR comment

- `artifacts/security/images/reports/*.trivy.json` – per-image scan output.
- `artifacts/security/images/scan_summary.json` – machine-readable aggregation
  (totals, delta, baseline state).
- `artifacts/security/images/scan_summary.html` – human-friendly rollup.
- `artifacts/security/images/pr_comment.md` – sticky PR comment containing the
  severity table, policy verdict, delta to the previous run, and baseline review
  hints.

### CI integration

The job `vuln-policy-images` in `.github/workflows/ci.yml` performs the
container scan on every push and pull request:

1. Installs the Trivy CLI.
2. Runs `python scripts/run_vuln_policy_images.py`, capturing the exit status.
3. Verifies that `artifacts/security/images/` matches the committed state
   (`git diff --exit-code`).
4. Posts `artifacts/security/images/pr_comment.md` as a sticky comment on pull
   requests.
5. Fails the job when unapproved High/Critical vulnerabilities remain.

The gate intentionally fails until new vulnerabilities are either fixed or added
(with justification) to the baseline.

### Current remediation plan (September 2025)

Siehe auch den fortlaufenden Tracker in `docs/security/container_remediation.md`.

- `infoterminal/frontend:latest` – Frontend squad will cut a dependency refresh (tickets `SEC-FE-127` to `SEC-FE-132`) that removes vulnerable transitive packages (`minimist`, `deep-extend`, `https-proxy-agent`, `form-data`, `json-schema`, `next`). Target release: sprint FT-2025.10 (mid October). Temporary baseline entries expire 2025-10-31.
- `libdb5.3` in NiFi/Promtail/Neo4j – Platform team to adopt vendor patches once published (NiFi 2.0.1+, Grafana Agent/Promtail >0.38, Neo4j 5.25). Interim baseline expires 2025-11-30 and must be reviewed during the November hardening window.
- Remaining critical findings (Airflow, Superset, Go stdlib/Crypto) stay unapproved; remediation owners must either upgrade upstream images or submit separate baseline requests with explicit expiry/owner.

For every baseline entry: link the acceptance back to an issue, set a short expiry (≤45 days), and document the follow-up in the release checklist before updating `policy/vuln_baseline_images.json` again.
