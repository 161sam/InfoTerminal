# Dependency Vulnerability Scanning

This document covers the automated Software Composition Analysis (SCA) checks that guard InfoTerminal's Python and Node.js dependencies.

## Overview

| Target | Scanner | Source Files | Output |
| --- | --- | --- | --- |
| Python services | OSV `querybatch` + per-vulnerability lookups | `requirements*.txt` (services, tests, etl) | `artifacts/security/sca/python/*.json` |
| Node workspace | `pnpm audit --json` | `pnpm-lock.yaml` | `artifacts/security/sca/node/pnpm-audit.json` |

The gate is implemented in `scripts/run_vuln_policy_sca.py`. It normalises severity levels, aggregates results across ecosystems, and enforces the `vuln_policy_sca` thresholds defined in `policy/vuln_policy_sca.json`.

## Running the scan locally

```bash
python scripts/run_vuln_policy_sca.py
```

The command performs the following steps:

1. Collects all `requirements*.txt` manifests and queries [osv.dev](https://osv.dev) for every pinned package. Unpinned requirements are reported as skipped and do not contribute to the vulnerability totals.
2. Executes `pnpm audit --json` against the workspace lockfile to detect Node vulnerabilities.
3. Writes deterministic artefacts under `artifacts/security/sca/`:
   - Per-manifest reports (`python/*.json`) mirroring OSV responses.
   - The raw `pnpm-audit.json` output (`node/`).
   - `sca_summary.json` and `sca_summary.html` with aggregated counts, policy status, and the top five advisories.
   - `pr_comment.md`, a ready-to-post Markdown summary used by CI for automated pull-request updates.

If high/critical issues are present, the script exits with status `1`. To inspect results without failing your shell session, append `|| true`.

## Policy configuration

`policy/vuln_policy_sca.json` stores the default severity thresholds:

```json
{
  "fail_threshold": "high",
  "warn_threshold": "medium"
}
```

The CLI accepts overrides via environment variables:

- `VULN_POLICY_SCA_FAIL_LEVEL` – override the fail threshold (e.g. `critical`).
- `VULN_POLICY_SCA_WARN_LEVEL` – override the warn threshold.

Both values must be one of `critical`, `high`, `medium`, `low`, `info`, or `unknown`.

Skipped (unpinned) Python requirements are counted and surfaced in the summary and PR comment. Use these lists to pin versions or add lockfiles so the scanner can evaluate them.

## CI integration

The GitHub Actions job `vuln-policy-sca` (see `.github/workflows/ci.yml`) runs on every push and pull request:

1. Installs pnpm dependencies with `pnpm install --frozen-lockfile --ignore-scripts`.
2. Runs `python scripts/run_vuln_policy_sca.py`, captures the exit code, and commits no changes.
3. Posts the contents of `artifacts/security/sca/pr_comment.md` as a sticky PR comment when applicable.
4. Fails the job if the recorded exit code is non-zero (i.e. high/critical vulnerabilities were detected).

Because the repository currently includes several high-severity issues (see the summary artefacts), the gate fails until the affected dependencies are upgraded. Adjust the policy only for exceptional cases; long-term remediation should update the pinned versions so the scan returns green.

## Artefact hygiene

The generated artefacts are committed to source control. Running the scanner in CI verifies that the committed files are up to date via `git diff --exit-code artifacts/security/sca`. If local scans produce changes, review and commit them together with dependency updates or policy adjustments.
