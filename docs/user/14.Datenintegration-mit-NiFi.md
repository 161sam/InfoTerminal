# 14. Datenintegration mit NiFi

Apache NiFi übernimmt in InfoTerminal die Aufnahme und Transformation von Daten. Die Flows sind auf Wiederholbarkeit und Auditierbarkeit ausgelegt.

---

## 14.1 Kernkonzepte

- **Processor Groups**: thematisch getrennte Schritte (Ingest, Normalize, Enrich, Deliver).
- **Parameter Contexts**: API-Keys, Verzeichnisse, Feature-Flags (z. B. `DRY_RUN`).
- **Provenance**: aktiviert, um Datenflüsse lückenlos zu protokollieren.
- **Templates**: im Repo (`docs/dev/nifi-ingest-demo.xml`); können importiert und angepasst werden.

---

## 14.2 Beispiel-Flows

| Flow | Zweck |
| ---- | ----- |
| `ingest_filewatch` | Beobachtet Verzeichnisse, extrahiert Metadaten, legt Rohdaten ab |
| `ingest_api_pull` | Holt periodisch Daten aus REST-APIs (z. B. Sanktionslisten) |
| `normalize_text` | Vereinheitlicht Encoding, Sprache, erzeugt Hashes |
| `doc_entities_pipeline` | Sendet Inhalt an Doc-Entities (`/v1/documents/annotate`), persistiert Ergebnisse |
| `graph_upsert` | Schreibt Entities/Relations über Graph-API (`/v1/cypher` mit parametrisierten MERGE-Statements) |
| `search_index` | Indexiert Dokumente in OpenSearch (`/_bulk`) |
| `aleph_sync` | Synchronisiert Collections/Metadaten zwischen Aleph und InfoTerminal |

---

## 14.3 Konfiguration

1. NiFi starten:
   ```bash
   docker compose -f docker-compose.nifi.yml --profile nifi up -d
   # UI: http://localhost:8080/nifi
   ```
2. Parameter setzen (Settings → Parameter Context): Endpoints (`SEARCH_API_URL`, `DOC_ENTITIES_URL`, `GRAPH_API_URL`), Auth, Ziel-Collections.
3. Controller Services: `StandardHttpContextMap`, `SSLContextService` bei Bedarf konfigurieren.
4. `InvokeHTTP`-Prozessoren verwenden `RequestBody`-Templates für Doc-Entities/Graph.

---

## 14.4 Übergabe in InfoTerminal

- **Doc-Entities** liefert Annotierungen zurück; NiFi persistiert JSON und leitet Entities an Graph weiter.
- **OpenSearch** erhält normalisierte Dokumente (mit `_id`, `_index`).
- **Graph**: Upserts, Relation-Schreibweise (Subject, Predicate, Object, Properties).
- **Geo**: GeoJSON-Dateien speichern (Graph-Views `geo/upload`).

---

## 14.5 Qualitätssicherung

- Testmodus (`DRY_RUN=1`) verhindert Schreiben in Echt-Systeme.
- Process Group Templates lassen sich im Repository versionieren.
- Fehlerpfade (Failure/Retry) in NiFi aktiv nutzen; an Slack/Email anbinden (n8n oder NiFi `PutEmail`).
- Provenance-Daten exportieren, um Audits zu ermöglichen.

Weitere Beispiele und Best Practices finden sich in `docs/dev/nifi-aleph.md` und `docs/dev/etl_automation.md`.
